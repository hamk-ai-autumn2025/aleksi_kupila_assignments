{% extends "layout.html" %}
{% block title %}Cybersecurity adversary simulator{% endblock %}

{% block content %}
    <h2>AI Adversary Simulator</h2>
    <div class="mb-3" id="requestArea">
        <form method="post" action="/suggest">
            <div class="mb-3">
                <label class="form-label">Instruction (natural language):</label><br/>
                <textarea class="form-control" id="user_request" name="instruction"></textarea><br/>
            </div>
        <button type="submit" class="btn btn-primary">Get Command Suggestion</button>
        </form>
    </div>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if suggestion %}
  <div id="suggestionArea" class="mb-3">
    <h3>AI Suggested Commands</h3>
    <form method="post" action="/run">
      {% for cmd in suggestion %}
        <div class="form-check">
          <input class="form-check-input" type="radio" name="approved_cmd" id="cmd{{ loop.index }}" value="{{ cmd.command }}" {% if loop.first %}checked{% endif %}>
          <label class="form-check-label" for="cmd{{ loop.index }}">
            <strong>Tool:</strong> {{ cmd.tool }} &nbsp; <strong>Command:</strong> <code>{{ cmd.command }}</code>
          </label>
        </div>
      {% endfor %}
      <br/>
      <button type="submit" class="btn btn-success">Run in Docker (executor)</button>
    </form>
  </div>
{% endif %}

{% if results %}
  <div id="outputArea" class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="mb-0">Execution Results</h3>
      <span class="text-muted small">{{ results|length }} item(s)</span>
    </div>

    <div class="accordion accordion-flush" id="accResults">
      {% for r in results %}
        {% set item_id = 'res' ~ loop.index %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="h{{ item_id }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c{{ item_id }}" aria-expanded="false" aria-controls="c{{ item_id }}">
              <span class="me-2 badge bg-secondary">#{{ loop.index }}</span>
              <code class="text-dark">{{ r.command }}</code>
            </button>
          </h2>
          <div id="c{{ item_id }}" class="accordion-collapse collapse" aria-labelledby="h{{ item_id }}" data-bs-parent="#accResults">
            <div class="accordion-body">
              <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="out-tab-{{ item_id }}" data-bs-toggle="tab" data-bs-target="#out-{{ item_id }}" type="button" role="tab" aria-controls="out-{{ item_id }}" aria-selected="true">Output</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="ana-tab-{{ item_id }}" data-bs-toggle="tab" data-bs-target="#ana-{{ item_id }}" type="button" role="tab" aria-controls="ana-{{ item_id }}" aria-selected="false">AI Analysis</button>
                </li>
              </ul>

              <div class="tab-content">
                <div class="tab-pane fade show active" id="out-{{ item_id }}" role="tabpanel" aria-labelledby="out-tab-{{ item_id }}">
                  <div class="border rounded bg-light p-2">
                    <pre class="mb-0 small" style="max-height: 350px; overflow: auto; white-space: pre-wrap;"><code>{{ r.stdout | default('') | e }}</code></pre>
                  </div>
                </div>
                <div class="tab-pane fade" id="ana-{{ item_id }}" role="tabpanel" aria-labelledby="ana-tab-{{ item_id }}">
                  <div class="border rounded bg-light p-2">
                    <pre class="mb-0 small" style="max-height: 350px; overflow: auto; white-space: pre-wrap;"><code>{{ r.prompt_analysis | default('') }}</code></pre>
                  </div>
                </div>
              </div>

              {% if r.tool %}
                <div class="mt-2 text-muted small">Tool: {{ r.tool }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="d-flex gap-2">
    <form method="post" action="/save" class="mb-0">
      <textarea name="results_json" class="d-none" aria-hidden="true">{{ results|tojson }}</textarea>
      <button type="submit" class="btn btn-success">Save session output (JSON)?</button>
    </form>
    <form method="post" action="/analysis" class="mb-0">
      <button type="submit" class="btn btn-outline-primary">Generate conclusive analysis?</button>
    </form>
  </div>
{% endif %}

{% if conclusive_analysis %}
<div>
  <textarea id="conclusive_analysis" name="conclusive_analysis" rows="12" readonly>{{ conclusive_analysis }}</textarea>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

{% endblock %}